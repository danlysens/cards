<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex AI üß†</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- –°–¢–ò–õ–ò (—Ç–µ –∂–µ —Å–∞–º—ã–µ, –Ω–æ –¥–æ–±–∞–≤–∏–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏) --- */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        
        #scan-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 5px solid white;
            background: rgba(255, 50, 50, 0.8); box-shadow: 0 0 15px rgba(255, 50, 50, 0.6);
            cursor: pointer; transition: transform 0.1s;
        }
        #scan-btn:active { transform: scale(0.9); }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        /* –≠–∫—Ä–∞–Ω –∫–æ–ª–ª–µ–∫—Ü–∏–∏ */
        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .card-info { padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; display: none; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loader">
            <div class="spinner"></div>
            <div>–†–∞—Å–ø–æ–∑–Ω–∞—é –∞–≤—Ç–æ...<br>–ò—â—É –≤ –±–∞–∑–µ...</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()"></button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –¢–û–ö–ï–ù –û–¢ HUGGING FACE (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ hf_)
        const HF_TOKEN = "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"; 
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –æ–±—É—á–µ–Ω–Ω—É—é –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è—Ö
        // (dima806/car_brand_model_classification - –æ–¥–Ω–∞ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π)
        const MODEL_URL = "https://api-inference.huggingface.co/models/dima806/car_brand_model_classification";

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loader = document.getElementById('loader');
        const scanBtn = document.getElementById('scan-btn');

        // 1. –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }
        }
        startCamera();

        // 2. –†–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API
        async function query(blob) {
            const response = await fetch(MODEL_URL, {
                headers: {
                    Authorization: `Bearer ${HF_TOKEN}`,
                    "Content-Type": "application/octet-stream",
                },
                method: "POST",
                body: blob,
            });
            const result = await response.json();
            return result;
        }

        // 3. –°–Ω–∏–º–æ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
        function captureAndIdentify() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            scanBtn.disabled = true;
            loader.style.display = 'block';

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Canvas –≤ Blob (—Ñ–∞–π–ª) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            canvas.toBlob(async function(blob) {
                try {
                    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –í –ù–ï–ô–†–û–°–ï–¢–¨
                    const results = await query(blob);
                    
                    console.log(results); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Å–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞)

                    if (results.error) {
                        // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å "—Å–ø–∏—Ç", –æ–Ω–∞ –º–æ–∂–µ—Ç –≥—Ä—É–∑–∏—Ç—å—Å—è 20 —Å–µ–∫—É–Ω–¥ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
                        alert("–ù–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è... –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥!");
                    } else if (Array.isArray(results) && results.length > 0) {
                        // –ë–µ—Ä–µ–º —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        const topResult = results[0];
                        const carName = topResult.label; 
                        const confidence = (topResult.score * 100).toFixed(1);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –≤ base64 –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
                        const imageData = canvas.toDataURL('image/jpeg');
                        
                        saveCar(carName, imageData, confidence);
                        alert(`üéØ –≠—Ç–æ ${carName}!\n–¢–æ—á–Ω–æ—Å—Ç—å: ${confidence}%`);
                        showCollection();
                    } else {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–æ–π—Ç–∏ –±–ª–∏–∂–µ.");
                    }
                } catch (error) {
                    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –¢–æ–∫–µ–Ω.");
                    console.error(error);
                } finally {
                    loader.style.display = 'none';
                    scanBtn.disabled = false;
                }
            }, 'image/jpeg', 0.8);
        }

        // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ì–∞–ª–µ—Ä–µ—è (LocalStorage)
        function saveCar(model, image, confidence) {
            let garage = JSON.parse(localStorage.getItem('realCarsDB')) || [];
            garage.push({
                id: Date.now(),
                model: model,
                image: image,
                confidence: confidence,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('realCarsDB', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            const garage = JSON.parse(localStorage.getItem('realCarsDB')) || [];
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –¢–æ—á–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                                ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function showCollection() {
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }
        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
        }

        renderGallery();
    </script>
</body>
</html>
