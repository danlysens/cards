<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex (–°–¢–ê–ë–ò–õ–¨–ù–´–ô) üß†</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        
        /* –ö–Ω–æ–ø–∫–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ */
        #scan-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; 
            background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); 
            cursor: pointer; transition: transform 0.1s; 
        }
        #scan-btn:active { transform: scale(0.9); }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        /* –õ–æ–∞–¥–µ—Ä */
        #loading-model, #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 11; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loading-model">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∑–≥–∞ –ò–ò... (15 –ú–ë)</div>
        </div>
        
        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <div>–°–∫–∞–Ω–∏—Ä—É—é...</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()" disabled></button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        let model;
        let stream;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingModel = document.getElementById('loading-model');
        const loader = document.getElementById('loader');
        const scanBtn = document.getElementById('scan-btn');

        // –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        const specificCarKeywords = [
            'sports car', 'convertible', 'hatchback', 'sedan', 'minivan', 'pickup truck', 
            'limousine', 'model t', 'station wagon', 'minibus', 
            // –î–æ–±–∞–≤–∏–º –±–æ–ª—å—à–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ MobileNet –∏–Ω–æ–≥–¥–∞ –∑–Ω–∞–µ—Ç:
            'porsche', 'ferrari', 'lamborghini', 'tesla', 'bmw', 'audi', 'mercedes', 'toyota', 'honda', 'nissan'
        ];
        
        // --- 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô –ò –ó–ê–ì–†–£–ó–ö–ê –ò–ò ---

        async function startCamera() {
            try {
                // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                if (stream) stream.getTracks().forEach(track => track.stop()); 

                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        async function init() {
            await startCamera(); 
            // –ó–∞–≥—Ä—É–∑–∫–∞ MobileNet
            model = await mobilenet.load();
            loadingModel.style.display = 'none';
            scanBtn.disabled = false;
        }
        
        // --- 2. –°–¢–ê–ë–ò–õ–¨–ù–û–ï –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ---

        async function captureAndIdentify() {
            // 1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            scanBtn.disabled = true;
            loader.style.display = 'block';

            let finalCarName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –û–±—ä–µ–∫—Ç üßê";
            let confidence = 0;
            let imageDataURL = null; 
            
            try {
                // 2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ MobileNet –ø—Ä—è–º–æ –∏–∑ —Ç–µ–≥–∞ <video> (—Å–∞–º—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
                const predictions = await model.classify(video);

                // 3. –°–Ω–∏–º–æ–∫ (–¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
                
                // 4. –£–ú–ù–´–ô –ê–ù–ê–õ–ò–ó (–£–ª—É—á—à–µ–Ω–∏–µ –ü.2)
                
                const carPredictions = predictions.filter(p => p.className.toLowerCase().includes('car') || p.className.toLowerCase().includes('truck') || p.className.toLowerCase().includes('suv'));

                let bestMatch = null;
                
                // 4.1. –ò—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–∏/—Ç–∏–ø—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                for (const label of carPredictions) {
                    const foundSpecific = specificCarKeywords.find(kw => label.className.toLowerCase().includes(kw));
                    if (foundSpecific) {
                        bestMatch = { name: label.className, score: label.probability };
                        break; 
                    }
                }

                // 4.2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, –±–µ—Ä–µ–º –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å 'car'
                if (!bestMatch && carPredictions.length > 0) {
                    bestMatch = { name: carPredictions[0].className, score: carPredictions[0].probability };
                }
                
                // 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if (bestMatch) {
                    // –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
                    finalCarName = bestMatch.name.split(',')[0].trim().replace('_', ' ');
                    confidence = (bestMatch.score * 100).toFixed(1);

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ "—Å—Ç–∞—Ä–∞—è/–Ω–æ–≤–∞—è"
                    if (finalCarName.toLowerCase().includes('model t')) {
                        finalCarName = `–°—Ç–∞—Ä–∏–Ω–Ω—ã–π Ford Model T`;
                    } else if (finalCarName.toLowerCase().includes('limousine')) {
                        finalCarName = `–õ–∏–º—É–∑–∏–Ω`;
                    } else if (finalCarName.toLowerCase().includes('sports car')) {
                        finalCarName = `–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å`;
                    } else if (finalCarName.toLowerCase().includes('suv')) {
                        finalCarName = `–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ / SUV`;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω–∏—á–µ–≥–æ, –±–µ—Ä–µ–º –ø—Ä–æ—Å—Ç–æ "–Ω–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π"
                if (finalCarName === "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –û–±—ä–µ–∫—Ç üßê") {
                     alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–æ–π—Ç–∏ –±–ª–∏–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∫—É—Ä—Å.");
                }

            } catch (error) {
                // –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –ø–æ–π–º–∞—Ç—å –æ—à–∏–±–∫—É "–û—à–∏–±–∫–∞ –ò–ò"
                console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è MobileNet:", error);
                finalCarName = "–û—à–∏–±–∫–∞ –ò–ò: –°–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏";
                alert("–û—à–∏–±–∫–∞ –ò–ò: –°–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
            } finally {
                // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥
                if (imageDataURL) {
                     saveCar(finalCarName, imageDataURL, confidence);
                }
               
                alert(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${finalCarName}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%`);
                
                loader.style.display = 'none';
                scanBtn.disabled = false;
                showCollection();
            }
        }
        
        // --- 3. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í (–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å) ---

        function showCollection() {
            stopCamera(); 
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }

        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
            startCamera(); 
        }

        // --- 4. –°–û–•–†–ê–ù–ï–ù–ò–ï (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function saveCar(model, image, confidence) {
            let garage = JSON.parse(localStorage.getItem('tfjsCarsDB_v2')) || [];
            garage.push({ id: Date.now(), model: model, image: image, confidence: confidence, date: new Date().toLocaleDateString() });
            localStorage.setItem('tfjsCarsDB_v2', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            const garage = JSON.parse(localStorage.getItem('tfjsCarsDB_v2')) || []; 
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                                –ü–æ–π–º–∞–Ω–∞: ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init();
        renderGallery();
    </script>
</body>
</html>
