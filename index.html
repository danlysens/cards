<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex Google Vision üöÄ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- –°–¢–ò–õ–ò (—Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ) --- */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        #scan-btn { width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); cursor: pointer; transition: transform 0.1s; }
        #scan-btn:active { transform: scale(0.9); }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .card-info { padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; display: none; background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4285f4; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loader">
            <div class="spinner"></div>
            <div>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Google Vision...</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()"></button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –ö–õ–Æ–ß GOOGLE VISION API
        const GOOGLE_API_KEY = "AIzaSyCdfCFyza7unaVJ4XdiCDUmELnIR4F6keE"; 
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        const GOOGLE_VISION_URL = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_API_KEY}`;
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loader = document.getElementById('loader');
        const scanBtn = document.getElementById('scan-btn');

        // 1. –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }
        }
        startCamera();
        
        // 2. –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è Google Vision
        async function captureAndIdentify() {
            if (GOOGLE_API_KEY === "–í–°–¢–ê–í–¨_–°–í–û–ô_–ö–õ–Æ–ß_–°–Æ–î–ê") {
                alert("–û–®–ò–ë–ö–ê: –°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π Google API Key –≤ –∫–æ–¥!");
                return;
            }
            
            scanBtn.disabled = true;
            loader.style.display = 'block';

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
            // –£–¥–∞–ª—è–µ–º "data:image/jpeg;base64," —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —á–∏—Å—Ç—ã–π base64
            const base64Image = imageDataURL.split(',')[1];

            const requestBody = {
                requests: [{
                    image: { content: base64Image },
                    features: [
                        { type: "LABEL_DETECTION", maxResults: 5 }, // –û–±—â–∏–µ –æ–±—ä–µ–∫—Ç—ã (–º–∞—à–∏–Ω–∞, —Å–µ–¥–∞–Ω)
                        { type: "LOGO_DETECTION", maxResults: 3 },  // –õ–æ–≥–æ—Ç–∏–ø (BMW, Toyota)
                    ]
                }]
            };

            try {
                const response = await fetch(GOOGLE_VISION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();
                
                // --- –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê ---
                let carName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –ê–≤—Ç–æ–º–æ–±–∏–ª—å üßê";
                const annotations = data.responses[0];
                
                // 1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –õ–û–ì–û–¢–ò–ü (—Å–∞–º–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ)
                if (annotations.logoAnnotations && annotations.logoAnnotations.length > 0) {
                    const logo = annotations.logoAnnotations[0];
                    carName = logo.description; // –ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞ (BMW, Mercedes)
                }

                // 2. –ï—Å–ª–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –Ω–µ—Ç, –∏—â–µ–º –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                if (carName === "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –ê–≤—Ç–æ–º–æ–±–∏–ª—å üßê" && annotations.labelAnnotations && annotations.labelAnnotations.length > 0) {
                    const carLabels = annotations.labelAnnotations.filter(
                        label => label.description.toLowerCase().includes('car') || label.description.toLowerCase().includes('vehicle') || label.description.toLowerCase().includes('automobile')
                    );
                    if (carLabels.length > 0) {
                        carName = carLabels[0].description; // –ù–∞–ø—Ä., "–°–µ–¥–∞–Ω", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
                    }
                }
                
                // 3. –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (carName === "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –ê–≤—Ç–æ–º–æ–±–∏–ª—å üßê") {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –ø—Ä–∏ –ª—É—á—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏!");
                } else {
                    saveCar(carName, imageDataURL);
                    alert(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${carName}`);
                    showCollection();
                }

            } catch (error) {
                alert("–û—à–∏–±–∫–∞ API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                console.error("Fetch Error:", error);
            } finally {
                loader.style.display = 'none';
                scanBtn.disabled = false;
            }
        }

        // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ì–∞–ª–µ—Ä–µ—è (LocalStorage)
        function saveCar(model, image) {
            let garage = JSON.parse(localStorage.getItem('visionCarsDB')) || [];
            garage.push({
                id: Date.now(),
                model: model,
                image: image,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('visionCarsDB', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            const garage = JSON.parse(localStorage.getItem('visionCarsDB')) || [];
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –ü–æ–π–º–∞–Ω–∞: ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 4. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showCollection() {
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }
        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
        }

        renderGallery();
    </script>
</body>
</html>
