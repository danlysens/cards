<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex (TF.js Free) üß†</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* (–°—Ç–∏–ª–∏ —Ç–µ –∂–µ, –Ω–æ –¥–æ–±–∞–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏) */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        #scan-btn { width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); cursor: pointer; transition: transform 0.1s; }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        #loading-model {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 11; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loading-model">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ò–ò... (15 –ú–ë)</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()" disabled>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let model; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ MobileNet
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingModel = document.getElementById('loading-model');
        const scanBtn = document.getElementById('scan-btn');

        // --- 1. –ó–ê–ì–†–£–ó–ö–ê –ò–ò –ú–û–î–ï–õ–ò –ò –ö–ê–ú–ï–†–´ ---
        async function init() {
            // 1. –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) {
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }

            // 2. –ó–∞–≥—Ä—É–∑–∫–∞ MobileNet (–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
            model = await mobilenet.load();
            loadingModel.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            scanBtn.disabled = false; // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            scanBtn.innerText = '–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫';

            console.log("–ú–æ–¥–µ–ª—å MobileNet –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!");
        }
        init();
        
        // --- 2. –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï (–†–ê–ë–û–¢–ê–ï–¢ –ù–ê –¢–ï–õ–ï–§–û–ù–ï) ---
        async function captureAndIdentify() {
            scanBtn.disabled = true;
            scanBtn.innerText = '–°–∫–∞–Ω–∏—Ä—É—é...';

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // 1. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é MobileNet
            const predictions = await model.classify(canvas);
            
            // 2. –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê: –ò—â–µ–º –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            let carName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –û–±—ä–µ–∫—Ç üßê";
            let confidence = 0;
            const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            // –ò—â–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
            // MobileNet –≤—ã–¥–∞–µ—Ç –∫–ª–∞—Å—Å—ã —Ç–∏–ø–∞ "—Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –º–∞—à–∏–Ω–∞", "–≥—Ä—É–∑–æ–≤–∏–∫"
            const carPredictions = predictions.filter(p => 
                p.className.toLowerCase().includes('car') || 
                p.className.toLowerCase().includes('automobile') ||
                p.className.toLowerCase().includes('truck') ||
                p.className.toLowerCase().includes('suv')
            );
            
            if (carPredictions.length > 0) {
                const bestPrediction = carPredictions[0];
                carName = bestPrediction.className;
                confidence = (bestPrediction.probability * 100).toFixed(1);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –º–∞—à–∏–Ω—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç
                carName = predictions[0].className;
                confidence = (predictions[0].probability * 100).toFixed(1);
            }

            // 3. –í—ã–≤–æ–¥
            saveCar(carName, imageDataURL, confidence);

            alert(`‚úÖ –ù–∞–π–¥–µ–Ω–æ (TF.js): ${carName}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%`);
            showCollection();
            
            scanBtn.disabled = false;
            scanBtn.innerText = '–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫';
        }

        // --- 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ì–ê–õ–ï–†–ï–Ø (LocalStorage) ---
        function saveCar(model, image, confidence) {
            let garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
            garage.push({
                id: Date.now(),
                model: model,
                image: image,
                confidence: confidence,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('tfjsCarsDB', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            const garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                                –ü–æ–π–º–∞–Ω–∞: ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- 4. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í ---
        function showCollection() {
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }
        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
        }

        renderGallery();
    </script>
</body>
</html>
