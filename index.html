<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex (TF.js Free) üß†</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        #scan-btn { width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); cursor: pointer; transition: transform 0.1s; }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        #loading-model {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 11; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="camera-screen">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="loading-model">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ò–ò... (15 –ú–ë)</div>
    </div>

    <div class="overlay">
        <div style="position: absolute; left: 20px; bottom: 35px;">
            <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
        </div>
        <button id="scan-btn" onclick="captureAndIdentify()" disabled></button>
    </div>
</div>

<div id="collection-screen">
    <div class="header">
        <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
        <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div id="list"></div>
</div>

<script>
let model;
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const loadingModel = document.getElementById('loading-model');
const scanBtn = document.getElementById('scan-btn');

// –°–ª–æ–≤–∞—Ä—å –º–æ–¥–µ–ª–µ–π –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
const carModels = {
    'sports car': 'Ferrari 488',
    'minivan': 'Toyota Sienna',
    'pickup truck': 'Ford F-150',
    'convertible': 'Mazda MX-5',
    'racing car': 'Lamborghini Huracan',
    'suv': 'Range Rover',
    'jeep': 'Jeep Wrangler',
    'cab': 'Toyota Prius',
    'limousine': 'Rolls Royce Phantom',
};

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –∏ –º–æ–¥–µ–ª–∏ ---
async function init() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        await video.play();
    } catch (err) {
        alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
        console.error(err);
        return;
    }

    model = await mobilenet.load();
    loadingModel.style.display = 'none';
    scanBtn.disabled = false;
    console.log("–ú–æ–¥–µ–ª—å MobileNet –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
}
init();

// --- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ---
async function captureAndIdentify() {
    if (!video.videoWidth || !video.videoHeight) return alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞!");

    scanBtn.disabled = true;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    const predictions = await model.classify(canvas);
    let carName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç üßê";
    let confidence = 0;

    const carPredictions = predictions.filter(p =>
        ['car', 'automobile', 'truck', 'suv', 'jeep'].some(key => p.className.toLowerCase().includes(key))
    );

    if (carPredictions.length > 0) {
        const bestPrediction = carPredictions[0];
        const key = bestPrediction.className.toLowerCase();
        carName = carModels[key] || bestPrediction.className;
        confidence = (bestPrediction.probability * 100).toFixed(1);
    } else {
        carName = predictions[0].className;
        confidence = (predictions[0].probability * 100).toFixed(1);
    }

    const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
    saveCar(carName, imageDataURL, confidence);
    alert(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${carName}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%`);
    showCollection();

    scanBtn.disabled = false;
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ ---
function saveCar(model, image, confidence) {
    let garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
    garage.push({
        id: Date.now(),
        model: model,
        image: image,
        confidence: confidence,
        date: new Date().toLocaleDateString()
    });
    localStorage.setItem('tfjsCarsDB', JSON.stringify(garage));
}

function renderGallery() {
    const list = document.getElementById('list');
    const garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
    document.getElementById('count').innerText = garage.length;
    list.innerHTML = '';

    garage.slice().reverse().forEach(car => {
        list.innerHTML += `
            <div class="card">
                <img src="${car.image}" alt="car">
                <div class="card-info">
                    <div style="font-weight:bold;">${car.model}</div>
                    <div style="font-size:0.8em; color:gray;">
                        –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                        –ü–æ–π–º–∞–Ω–∞: ${car.date}
                    </div>
                </div>
            </div>
        `;
    });
}

// --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ ---
function showCollection() {
    renderGallery();
    document.getElementById('camera-screen').style.display = 'none';
    document.getElementById('collection-screen').style.display = 'block';
}
function showCamera() {
    document.getElementById('collection-screen').style.display = 'none';
    document.getElementById('camera-screen').style.display = 'flex';
}

renderGallery();
</script>
</body>
</html>
