<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex (–°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø TF.JS) ‚úÖ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        
        /* –ö–Ω–æ–ø–∫–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–ü—É–Ω–∫—Ç 3) */
        #scan-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; 
            background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); 
            cursor: pointer; transition: transform 0.1s; 
        }
        #scan-btn:active { transform: scale(0.9); }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        /* –õ–æ–∞–¥–µ—Ä—ã */
        #loading-model, #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 11; background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loading-model">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∑–≥–∞ –ò–ò... (15 –ú–ë)</div>
        </div>
        
        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <div>–°–∫–∞–Ω–∏—Ä—É—é...</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()" disabled></button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        let model;
        let stream;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingModel = document.getElementById('loading-model');
        const loader = document.getElementById('loader');
        const scanBtn = document.getElementById('scan-btn');

        // –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –¥–ª—è —É–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–ü—É–Ω–∫—Ç 2)
        const specificCarKeywords = [
            'sports car', 'convertible', 'hatchback', 'sedan', 'minivan', 'pickup truck', 
            'limousine', 'model t', 'station wagon', 'minibus', 'suv',
            'porsche', 'ferrari', 'lamborghini', 'tesla', 'bmw', 'audi', 'mercedes', 'toyota', 'honda', 'nissan',
            'jeep', 'truck', 'land rover', 'fiat', 'chevrolet', 'mustang' // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–æ–∫
        ];
        
        // --- 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô –ò –ó–ê–ì–†–£–ó–ö–ê –ò–ò ---

        async function startCamera() {
            try {
                // –ü–ª–∞–≤–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                if (stream) stream.getTracks().forEach(track => track.stop()); 
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }
        }
        
        function stopCamera() {
             if (stream) {
                 stream.getTracks().forEach(track => track.stop());
                 video.srcObject = null;
             }
        }

        async function init() {
            await startCamera(); 
            model = await mobilenet.load();
            loadingModel.style.display = 'none';
            scanBtn.disabled = false;
        }
        
        // --- 2. –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï (–¢–í–û–Ø –õ–û–ì–ò–ö–ê + –ü–ï–†–ï–î–ï–õ–ê–ù–ù–´–ô –§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö) ---

        async function captureAndIdentify() {
            // –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            scanBtn.disabled = true;
            loader.style.display = 'block';

            let finalCarName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –û–±—ä–µ–∫—Ç üßê";
            let confidence = 0;
            let imageDataURL = null; 
            
            try {
                // 1. –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞ –Ω–∞ Canvas
                canvas.width = video.videoWidth;
                canvas.height = video.height; // –ò—Å–ø–æ–ª—å–∑—É–µ–º height –∏–∑ –≤–∏–¥–µ–æ
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                imageDataURL = canvas.toDataURL('image/jpeg', 0.8);

                // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø–æ–º–æ—â—å—é MobileNet
                const predictions = await tf.tidy(() => model.classify(canvas)); 
                
                // 3. –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–∫
                const labels = predictions.map(p => ({
                    name: p.className.toLowerCase(),
                    score: p.probability
                }));
                
                let bestMatch = null;
                
                for (const label of labels) {
                    // –ï—Å–ª–∏ –º–µ—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'bmw', 'sedan')
                    const keywordFound = specificCarKeywords.find(kw => label.name.includes(kw));

                    if (keywordFound) {
                        // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –º–µ—Ç–∫–∞ –ò–õ–ò –µ—Å–ª–∏ —ç—Ç–æ –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–æ —Å–∏—Ö –ø–æ—Ä
                        if (!bestMatch || label.score > bestMatch.score) {
                            bestMatch = label;
                        }
                    }
                }

                if (bestMatch) {
                    // –ü—Ä–∏–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º–æ–º—É –≤–∏–¥—É
                    finalCarName = bestMatch.name.split(',')[0].trim().replace('_', ' ');
                    confidence = (bestMatch.score * 100).toFixed(1);

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ "—Å—Ç–∞—Ä–∞—è/–Ω–æ–≤–∞—è"
                    if (finalCarName.includes('model t')) {
                        finalCarName = `–°—Ç–∞—Ä–∏–Ω–Ω—ã–π Ford Model T`;
                    } else if (finalCarName.includes('sports car')) {
                        finalCarName = `–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –ê–≤—Ç–æ–º–æ–±–∏–ª—å`;
                    } else if (finalCarName.includes('suv')) {
                        finalCarName = `–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ / SUV`;
                    }

                } else {
                    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ —É–º–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É, –±–µ—Ä–µ–º –ø—Ä–æ—Å—Ç–æ "–º–∞—à–∏–Ω–∞"
                    const genericCar = labels.find(l => l.name.includes('car') || l.name.includes('vehicle'));
                    if (genericCar) {
                        finalCarName = genericCar.name.split(',')[0].trim().replace('_', ' ');
                        confidence = (genericCar.score * 100).toFixed(1);
                    } else {
                        // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞—à–ª–∏ –º–∞—à–∏–Ω—É, –±–µ—Ä–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        finalCarName = labels[0].name.split(',')[0].trim().replace('_', ' ');
                        confidence = (labels[0].score * 100).toFixed(1);
                    }
                }
                
                if (finalCarName === "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –û–±—ä–µ–∫—Ç üßê") {
                     alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è.");
                }

            } catch (error) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
                console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è MobileNet:", error);
                finalCarName = "–°–ë–û–ô: –ü–æ–≤—Ç–æ—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";
                alert("–°–ë–û–ô: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–¥—Ä. –ü–æ–≤—Ç–æ—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.");
            } finally {
                // 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ)
                if (imageDataURL && !finalCarName.includes("–°–ë–û–ô")) {
                     saveCar(finalCarName, imageDataURL, confidence);
                }
               
                alert(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${finalCarName}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%`);
                
                loader.style.display = 'none';
                scanBtn.disabled = false;
                showCollection();
            }
        }
        
        // --- 3. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í ---

        function showCollection() {
            // –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –ì–∞—Ä–∞–∂
            stopCamera(); 
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }

        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
            // –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –ì–∞—Ä–∞–∂–∞
            startCamera(); 
        }

        // --- 4. –°–û–•–†–ê–ù–ï–ù–ò–ï ---
        function saveCar(model, image, confidence) {
            let garage = JSON.parse(localStorage.getItem('tfjsCarsDB_vFinalV2')) || [];
            garage.push({ id: Date.now(), model: model, image: image, confidence: confidence, date: new Date().toLocaleDateString() });
            localStorage.setItem('tfjsCarsDB_vFinalV2', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            const garage = JSON.parse(localStorage.getItem('tfjsCarsDB_vFinalV2')) || []; 
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                                –ü–æ–π–º–∞–Ω–∞: ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        init();
        renderGallery();
    </script>
</body>
</html>
