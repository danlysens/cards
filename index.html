<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarDex (TF.js Free) üß†</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body { font-family: 'Roboto', sans-serif; background: #222; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #camera-screen { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .overlay { position: relative; z-index: 2; width: 100%; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        
        /* –ö–Ω–æ–ø–∫–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ –∫—Ä—É–≥ */
        #scan-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; 
            background: rgba(50, 150, 255, 0.8); box-shadow: 0 0 15px rgba(50, 150, 255, 0.6); 
            cursor: pointer; transition: transform 0.1s; 
        }
        #scan-btn:active { transform: scale(0.9); }
        #scan-btn:disabled { background: gray; border-color: #555; cursor: not-allowed; }

        /* –õ–æ–∞–¥–µ—Ä */
        #loading-model, #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 11; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; text-align: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #collection-screen { display: none; background: #f5f5f5; color: #333; height: 100%; overflow-y: auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; }
        .card img { width: 100px; height: 80px; object-fit: cover; }
        .nav-btn { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="camera-screen">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        
        <div id="loading-model">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∑–≥–∞ –ò–ò... (15 –ú–ë)</div>
        </div>
        
        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <div>–°–∫–∞–Ω–∏—Ä—É—é...</div>
        </div>

        <div class="overlay">
            <div style="position: absolute; left: 20px; bottom: 35px;">
                <button onclick="showCollection()" class="nav-btn">üèÜ –ì–∞—Ä–∞–∂</button>
            </div>
            <button id="scan-btn" onclick="captureAndIdentify()" disabled></button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="header">
            <h2>–ú–æ–π –ì–∞—Ä–∞–∂ (<span id="count">0</span>)</h2>
            <button onclick="showCamera()" class="nav-btn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        let model;
        let stream; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingModel = document.getElementById('loading-model');
        const loader = document.getElementById('loader');
        const scanBtn = document.getElementById('scan-btn');

        // –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ MobileNet –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –º–∞—à–∏–Ω
        const specificCarKeywords = [
            'sports car', 'convertible', 'hatchback', 'sedan', 'minivan', 
            'pickup truck', 'limousine', 'model t', 'beach wagon', 'station wagon',
            // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ MobileNet –∏–Ω–æ–≥–¥–∞ –∑–Ω–∞–µ—Ç
            'porsche', 'ferrari', 'tesla', 'bmw', 'audi', 'mercedes', 'ford', 'chevrolet'
        ];
        
        // --- 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü.1) ---

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!");
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        async function init() {
            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            await startCamera(); 

            // –ó–∞–≥—Ä—É–∑–∫–∞ MobileNet
            model = await mobilenet.load();
            loadingModel.style.display = 'none';
            scanBtn.disabled = false;
        }
        
        // --- 2. –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï (–£–õ–£–ß–®–ï–ù–ò–ï –ü.2) ---
        async function captureAndIdentify() {
            // 1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            scanBtn.disabled = true;
            loader.style.display = 'block';
            stopCamera(); // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω–∏–º–∫–æ–º

            // 2. –°–Ω–∏–º–æ–∫
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            let finalCarName = "–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –ê–≤—Ç–æ–º–æ–±–∏–ª—å üßê";
            let confidence = 0;
            const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            try {
                // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò
                const predictions = await model.classify(canvas);

                // 4. –£–ú–ù–´–ô –ê–ù–ê–õ–ò–ó (–∏—â–µ–º —Ç–æ—á–Ω—ã–µ —Ç–∏–ø—ã/–º–∞—Ä–∫–∏)
                const carPredictions = predictions.filter(p => p.className.toLowerCase().includes('car') || p.className.toLowerCase().includes('truck'));

                let bestMatch = null;

                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, —Ä–µ–¥–∫–∏–µ –∫–ª–∞—Å—Å—ã
                for (const label of carPredictions) {
                    const foundSpecific = specificCarKeywords.find(kw => label.className.toLowerCase().includes(kw));
                    
                    if (foundSpecific) {
                        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ (BMW, Model T), —Å—Ç–∞–≤–∏–º —ç—Ç–æ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        bestMatch = { name: label.className, score: label.probability };
                        break; // –í—ã—Ö–æ–¥–∏–º, —Ç–∞–∫ –∫–∞–∫ –Ω–∞—à–ª–∏ –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    }
                }

                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∞—Ä–∫—É, –±–µ—Ä–µ–º —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π –∫–ª–∞—Å—Å, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –º–∞—à–∏–Ω–æ–π
                if (!bestMatch && carPredictions.length > 0) {
                    bestMatch = { name: carPredictions[0].className, score: carPredictions[0].probability };
                }
                
                // 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if (bestMatch) {
                    // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ (—Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ), —É–±–∏—Ä–∞–µ–º –∑–∞–ø—è—Ç—ã–µ –∏ –Ω–∏–∂–Ω–∏–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
                    finalCarName = bestMatch.name.split(',')[0].trim().replace('_', ' ');
                    confidence = (bestMatch.score * 100).toFixed(1);

                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "—Å—Ç–∞—Ä–∞—è/–Ω–æ–≤–∞—è" –Ω–∞ –æ—Å–Ω–æ–≤–µ MobileNet
                    if (finalCarName.toLowerCase().includes('model t')) {
                        finalCarName = `–°—Ç–∞—Ä–∏–Ω–Ω—ã–π Ford Model T`;
                    } else if (finalCarName.toLowerCase().includes('limousine')) {
                        finalCarName = `–õ–∏–º—É–∑–∏–Ω`;
                    } else if (finalCarName.toLowerCase().includes('sports car')) {
                        finalCarName = `–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å`;
                    }
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", error);
                finalCarName = "–û—à–∏–±–∫–∞ –ò–ò";
            } finally {
                // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥
                saveCar(finalCarName, imageDataURL, confidence);
                alert(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${finalCarName}\n–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%`);
                
                loader.style.display = 'none';
                scanBtn.disabled = false;
                showCollection();
            }
        }
        
        // --- 3. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í –ò –í–û–ó–û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–´ ---
        function showCollection() {
            stopCamera(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –ì–∞—Ä–∞–∂
            renderGallery();
            document.getElementById('camera-screen').style.display = 'none';
            document.getElementById('collection-screen').style.display = 'block';
        }

        function showCamera() {
            document.getElementById('collection-screen').style.display = 'none';
            document.getElementById('camera-screen').style.display = 'flex';
            startCamera(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –æ–±—Ä–∞—Ç–Ω–æ
        }

        // --- 4. –°–û–•–†–ê–ù–ï–ù–ò–ï (–û—Å—Ç–∞–ª–æ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function saveCar(model, image, confidence) {
            let garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
            garage.push({ id: Date.now(), model: model, image: image, confidence: confidence, date: new Date().toLocaleDateString() });
            localStorage.setItem('tfjsCarsDB', JSON.stringify(garage));
        }

        function renderGallery() {
            const list = document.getElementById('list');
            const garage = JSON.parse(localStorage.getItem('tfjsCarsDB')) || [];
            document.getElementById('count').innerText = garage.length;
            list.innerHTML = '';
            
            garage.reverse().forEach(car => {
                list.innerHTML += `
                    <div class="card">
                        <img src="${car.image}" alt="car">
                        <div class="card-info">
                            <div style="font-weight:bold;">${car.model}</div>
                            <div style="font-size:0.8em; color:gray;">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${car.confidence}%<br>
                                –ü–æ–π–º–∞–Ω–∞: ${car.date}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        init();
        renderGallery();
    </script>
</body>
</html>
